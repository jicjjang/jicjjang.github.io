{"componentChunkName":"component---src-templates-post-template-tsx","path":"/posts/bivariance-in-react2","result":{"data":{"site":{"siteMetadata":{"title":"June"}},"markdownRemark":{"id":"77031721-1b16-5bdf-917a-7e111357d1a9","excerpt":"bivariance(이변성) in react1 post에서 에 대해 공변성, 반공변성과 함께 알아보았습니다. 이번에는 정말 알고싶었던 ref 타입에서의 bivarianceHack이란게 뭔지 한번 알아보겠습니다. 원래 의문을 가지게 된 코드입니다. 이 코드는 react dom의 ref…","html":"<p><a href=\"https://jicjjang.github.io/posts/bivariance-in-react1\" target=\"_blank\" rel=\"noopener\">bivariance(이변성) in react1</a> post에서 <code class=\"language-text\">bivariance</code>에 대해 공변성, 반공변성과 함께 알아보았습니다. 이번에는 정말 알고싶었던 ref 타입에서의 bivarianceHack이란게 뭔지 한번 알아보겠습니다.</p>\n<p>원래 의문을 가지게 된 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token operator\">...</span>\n<span class=\"token comment\">// Bivariance hack for consistent unsoundness with RefObject</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">RefCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">bivarianceHack</span><span class=\"token punctuation\">(</span>instance<span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"bivarianceHack\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> RefCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> RefObject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">LegacyRef<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>이 코드는 react dom의 ref 속성에 ref대신 callback function을 넣을 수 있도록 정의된 <code class=\"language-text\">RefCallback</code> 타입입니다.\n주석은 직역하자면 <code class=\"language-text\">RefObject의 일관적인 불건전함을 위한 이변성의 속임수</code> 정도로 볼 수 있겠네요.</p>\n<p><code class=\"language-text\">bivariance(이변성) in react1</code> 포스트를 작성하면서 이해한 공변성, 반공변성, 이변성의 성질을 가지고 <code class=\"language-text\">불건전함</code>, <code class=\"language-text\">이변성의 속임수</code>에 대해 한번 같이 알아보겠습니다.</p>\n<h2 id=\"불건전함\" style=\"position:relative;\">불건전함<a href=\"#%EB%B6%88%EA%B1%B4%EC%A0%84%ED%95%A8\" aria-label=\"불건전함 permalink\" class=\"autolink-headers-- after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>타입스크립트는 compile time에 확인할 수 없는 코드들이 있는데, 이러한 코드도 안전하게 돌아갈 수 있도록 해줍니다.\n이 때, 안전함을 확인할 수 있는 코드를 <a href=\"https://www.typescriptlang.org/docs/handbook/type-compatibility.html#a-note-on-soundness\" target=\"_blank\" rel=\"noopener\">건전(sound)</a>하다고 표현하며, 안전함을 확인할 수 없는 코드를 [불건전(unsound)]하다고 표현합니다.</p>\n<h2 id=\"이변성의-속임수\" style=\"position:relative;\">이변성의 속임수<a href=\"#%EC%9D%B4%EB%B3%80%EC%84%B1%EC%9D%98-%EC%86%8D%EC%9E%84%EC%88%98\" aria-label=\"이변성의 속임수 permalink\" class=\"autolink-headers-- after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>앞선 포스트에서 tsconfig의 <code class=\"language-text\">strictFunctionTypes</code> 옵션의 설정 여부에 따라 function type은 <code class=\"language-text\">이변성</code> or <code class=\"language-text\">반불변성</code>을 가진다는 얘기를 했었습니다.</p>\n<p>점점 글을 쓸수록 전 포스트에서 저희가 알아봤던 <a href=\"http://localhost:8000/posts/bivariance-in-react1/#%EC%84%A4%EC%A0%95-%EB%B0%8F-%EA%BC%BC%EC%88%98\" target=\"_blank\" rel=\"noopener\">설정 및 꼼수</a> 에서의 <code class=\"language-text\">클래스 구조로 코드 만들기</code> 와 유사하다는 생각이 듭니다. <code class=\"language-text\">설정 및 꼼수</code>에서 2, 3번은 type과 interface를 확장하는 방식으로 꼼수를 부리는건데 이들은 사실 하나라고 해도 될 정도로 유사합니다.</p>\n<p>이 추측이 맞을지 react가 설치된 프로젝트에서 타입을 수정해서 저장했을 때, 에러 발생하는지 테스트를 한번 해보겠습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 480px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0f60bb1a98d29bdf84304b62aff8f905/aa597/react-bivariance-hack.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAByYgB/8QAFhAAAwAAAAAAAAAAAAAAAAAAEBEg/9oACAEBAAEFAoY//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAwADAAAAAAAAAAAAAAAAAAEREHGB/9oACAEBAAE/IV0a2QpWP//aAAwDAQACAAMAAAAQUw//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAcEAEAAgIDAQAAAAAAAAAAAAABABEhQTFhocH/2gAIAQEAAT8Q4fEsdjtjlj2XFCKbqXP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"react-bivariance-hack\"\n        title=\"react-bivariance-hack\"\n        src=\"/static/0f60bb1a98d29bdf84304b62aff8f905/7cc5e/react-bivariance-hack.jpg\"\n        srcset=\"/static/0f60bb1a98d29bdf84304b62aff8f905/e439a/react-bivariance-hack.jpg 120w,\n/static/0f60bb1a98d29bdf84304b62aff8f905/09b79/react-bivariance-hack.jpg 240w,\n/static/0f60bb1a98d29bdf84304b62aff8f905/7cc5e/react-bivariance-hack.jpg 480w,\n/static/0f60bb1a98d29bdf84304b62aff8f905/80e3c/react-bivariance-hack.jpg 720w,\n/static/0f60bb1a98d29bdf84304b62aff8f905/6a068/react-bivariance-hack.jpg 960w,\n/static/0f60bb1a98d29bdf84304b62aff8f905/aa597/react-bivariance-hack.jpg 1548w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>에러 없이 잘 실행되는 모습입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\">  <span class=\"token operator\">...</span>\n  <span class=\"token comment\">// Bivariance hack for consistent unsoundness with RefObject</span>\n  <span class=\"token keyword\">type</span> <span class=\"token class-name\">RefCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instance<span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Bivariance hack 임시 제거</span>\n  <span class=\"token keyword\">type</span> <span class=\"token class-name\">Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> RefCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> RefObject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">type</span> <span class=\"token class-name\">LegacyRef<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">...</span></code></pre></div>\n<p>정상적이었던 코드를 위와 같이 일반 arrow function 구조로 변경했습니다.\n어떤 에러가 발생할까요?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 480px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1f3abe0395bc844db1142313306926c4/2bbf0/change.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAABypAD/8QAFhABAQEAAAAAAAAAAAAAAAAAABEx/9oACAEBAAEFAsVX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAGRAAAQUAAAAAAAAAAAAAAAAAAQAQESFx/9oACAEBAAE/ISZGlln/2gAMAwEAAgADAAAAEHAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRABAQEAAwAAAAAAAAAAAAAAAREAMUHw/9oACAEBAAE/EDABRl43i63rf//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"change\"\n        title=\"change\"\n        src=\"/static/1f3abe0395bc844db1142313306926c4/7cc5e/change.jpg\"\n        srcset=\"/static/1f3abe0395bc844db1142313306926c4/e439a/change.jpg 120w,\n/static/1f3abe0395bc844db1142313306926c4/09b79/change.jpg 240w,\n/static/1f3abe0395bc844db1142313306926c4/7cc5e/change.jpg 480w,\n/static/1f3abe0395bc844db1142313306926c4/80e3c/change.jpg 720w,\n/static/1f3abe0395bc844db1142313306926c4/6a068/change.jpg 960w,\n/static/1f3abe0395bc844db1142313306926c4/2bbf0/change.jpg 1496w\"\n        sizes=\"(max-width: 480px) 100vw, 480px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>dom ref에 등록한 곳이 많았는데, 특정 ref 단 두곳에만 에러가 발생했습니다.\n에러가 발생항는 곳은 <a href=\"https://reactjs.org/docs/forwarding-refs.html\" target=\"_blank\" rel=\"noopener\">forwardRef</a>를 사용한 곳이었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token operator\">...</span>\n<span class=\"token comment\">// 제네릭 타입 2개. 순서대로 ref의 타입과 props의 타입</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Button <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">forwardRef</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>HTMLButtonElement<span class=\"token punctuation\">,</span> IButtonProps<span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>StyledButton\n      ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>ref<span class=\"token punctuation\">}</span> <span class=\"token comment\">// ForwaredRef&lt;HTMLButtonElement> 타입이 들어감</span>\n      <span class=\"token operator\">...</span></code></pre></div>\n<p>그럼 dom ref의 타입과 <code class=\"language-text\">ForwaredRef</code>의 타입은 어떨까요?</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">RefAttributes<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Attributes</span> <span class=\"token punctuation\">{</span>\n  ref<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> RefCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> RefObject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// => 합친다면 아래와 같음</span>\nref<span class=\"token operator\">?</span><span class=\"token operator\">:</span> RefCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> RefObject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>dom에서 ref를 받을 때는 RefCallback, RefObject, null, undefined가 가능합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">ForwardedRef<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>instance<span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> MutableRefObject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>값을 넣어주는 ForwaredRef는 일반 함수, MutableRefObject, null이 가능합니다.\n이 둘은 반공변성이 성립되지 않습니다.</p>\n<p>위 코드를 테스트하면서 이상한 부분을 하나 찾을 수 있었습니다. <code class=\"language-text\">dom ref에 등록한 곳이 많았는데, 특정 ref 단 두곳에만 에러가 발생...</code> 이라는게 뭔가 이상했기에 에러가 발생하지 않는 dom ref도 한번 살펴봤는데요, forwordRef를 사용하는데도 정상적인 부분이 있었습니다...!!!</p>\n<p>차이는 dom ref를 받는 곳에서 <code class=\"language-text\">ClassAttributes</code>를 참조하는 부분과 <code class=\"language-text\">RefAttributes</code>를 참조하는 부분이 있다는 것이었습니다. emotion을 쓰면서 생성한 dom은 모두 <code class=\"language-text\">ClassAttributes</code>를 참조하는데 정상적으로 동작하였으며, antd를 사용하며 styled로 한번 컴포넌트를 감싼 결과물은 <code class=\"language-text\">RefAttributes</code>를 참조하고 있었습니다. 이는 에러가 발생하고 있었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token operator\">...</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">RefAttributes<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Attributes</span> <span class=\"token punctuation\">{</span>\n    ref<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">ClassAttributes<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Attributes</span> <span class=\"token punctuation\">{</span>\n    ref<span class=\"token operator\">?</span><span class=\"token operator\">:</span> LegacyRef<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p>제가 이상하다고 느낀 부분은 이 둘의 타입은 차이가 없다는 것입니다.\n<code class=\"language-text\">LegacyRef</code> 타입은 <code class=\"language-text\">Bivariance hack for consistent unsoundness with RefObject</code> 주석이 있을 때 보여드린 코드에도 있지만 <code class=\"language-text\">type LegacyRef&lt;T&gt; = string | Ref&lt;T&gt;;</code> 이렇게 간단합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token operator\">...</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">RefAttributes<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Attributes</span> <span class=\"token punctuation\">{</span>\n    ref<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">ClassAttributes<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Attributes</span> <span class=\"token punctuation\">{</span>\n    ref<span class=\"token operator\">?</span><span class=\"token operator\">:</span> LegacyRef<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">LegacyRef<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\n\n<span class=\"token comment\">// => LegacyRef 타입을 합쳐본다면?</span>\n\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">RefAttributes<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Attributes</span> <span class=\"token punctuation\">{</span>\n    ref<span class=\"token operator\">?</span><span class=\"token operator\">:</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">interface</span> <span class=\"token class-name\">ClassAttributes<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Attributes</span> <span class=\"token punctuation\">{</span>\n    ref<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>아니 그럼 <code class=\"language-text\">RefAttributes 타입과 ClassAttributes 타입의 차이는 string 타입 하나네?</code> 라는 생각이 절로듭니다.</p>\n<p>하지만 RefAttributes타입에 string 타입을 강제로 넣어봐도 에러가 변하진 않습니다...\n이 또한 하나의 꼼수일수도 있는 부분인데, <code class=\"language-text\">LagacyRef</code>라는 타입이 굳이 있는 이유일수도 있습니다.</p>\n<p>interface, type은 하나의 interface, type을 더 거치면 정확한 타입비교가 안됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\">  <span class=\"token operator\">...</span>\n  <span class=\"token comment\">// Bivariance hack for consistent unsoundness with RefObject</span>\n  <span class=\"token keyword\">type</span> <span class=\"token class-name\">RefCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>instance<span class=\"token operator\">:</span> <span class=\"token constant\">T</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Bivariance hack 임시 제거</span>\n  <span class=\"token keyword\">type</span> <span class=\"token class-name\">Test</span> <span class=\"token operator\">=</span> RefCallback<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> RefObject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 추가됨!!!</span>\n  <span class=\"token keyword\">type</span> <span class=\"token class-name\">Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> Test <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 추가됨!!!</span>\n  <span class=\"token keyword\">type</span> <span class=\"token class-name\">LegacyRef<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">|</span> Ref<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  <span class=\"token operator\">...</span></code></pre></div>\n<p><code class=\"language-text\">Ref&lt;T&gt;</code>가 바로 <code class=\"language-text\">RefCallback&lt;T&gt; | RefObject&lt;T&gt;</code> 타입에 접근하지 않고 <code class=\"language-text\">Test</code>라는 타입을 하나 거치게 했더니 에러가 해결되었습니다.\n아마 LegacyRef도 <code class=\"language-text\">ClassAttributes</code>에서 이슈를 해결하기 위해 임시로 만들었다가 계속 사용되게 아닌가 생각이 들더군요.</p>\n<p>제가 찾아낸 이런 방법이 <code class=\"language-text\">Bivariance hack을 넣을 필요없이 하나 더 거치게 하자</code> 라고 딱 잘라 말할순 없습니다.\n다른 엣지케이스는 없을지 확인해본것도 아니고, 그저 에러하나 없어지도록 확인해 본것이니까요.</p>\n<hr>\n<p>여기까지 이변성의 속임수가 어떤것인지 확인해봤는데 다른 방향으로 글이 길어졌네요.\n결론적으로는 지난 post에서 말했던 <code class=\"language-text\">설정 및 꼼수</code>를 react 타입에서도 사용했다는 것이고, hack은 말그대로 hack이니까 해결할 수 있는 방법은 더 있을 것입니다.\n하지만 해결하기 껄끄러우니 hack을 사용한 것일거구요.</p>\n<p>주석 하나로 쏘아올린 작은 공... 이라고 해야되나요. 두 편으로 나눠 긴 포스트를 작성해봤습니다.\n덕분에 오늘도 react, typescript의 중요한 부분 중 하나를 알고 갑니다.</p>","frontmatter":{"title":"bivariance(이변성) in react2","date":"February 03, 2023","tags":["react","bivariance","covariance","contravariance"]}}},"pageContext":{"slug":"/posts/bivariance-in-react2","previous":{"fields":{"slug":"/posts/bivariance-in-react1"},"frontmatter":{"title":"bivariance(이변성) in react1"}},"next":null}},"staticQueryHashes":["1576648375","1963346411"]}